<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Dream Earth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  
 


  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
      background: #111;
    }
	
	
	 /* æ¢¦çš„è½»å¾®å‘¼å¸åŠ¨ç”» */
@keyframes dreamBreath {
  0%   { transform: scale(1);   opacity: 1; }
  50%  { transform: scale(1.3); opacity: 0.9; }
  100% { transform: scale(1);   opacity: 1; }
}

/* åªç»™â€œæ–°æ¢¦â€ç”¨ */
.dream-breath {
  animation: dreamBreath 6s ease-in-out infinite;
  transform-origin: center;
}
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// åŸå¸‚ â†’ åæ ‡ å¯¹ç…§è¡¨
var cityCoordinates = {
  "åŒ—äº¬": [39.9042, 116.4074],
  "ä¸Šæµ·": [31.2304, 121.4737],
  "æ­å·": [30.2741, 120.1551],
  "å®æ³¢": [29.8683, 121.5440],
  "å¹¿å·": [23.1291, 113.2644],
  "æ·±åœ³": [22.5431, 114.0579],
  "æˆéƒ½": [30.5728, 104.0668],
  "æ­¦æ±‰": [30.5928, 114.3055]
};

/*************************
 * 1. åˆå§‹åŒ–åœ°å›¾
 *************************/
 // ä»ç½‘å€ä¸­è¯»å–ä½ç½®å‚æ•°
var params = new URLSearchParams(window.location.search);
var lat = params.get('lat');
var lng = params.get('lng');

 
var center = [30, 0];
var zoom = 2;

if (lat && lng) {
  center = [parseFloat(lat), parseFloat(lng)];
  zoom = 6;
}

var map = L.map('map').setView(center, zoom);


L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

/*************************
 * 2. æƒ…ç»ª â†’ é¢œè‰²ï¼ˆè®°å½•ä¼˜å…ˆç‰ˆï¼‰
 *************************/
var emotionColors = {
  calm:      '#A7B8C9', // æ¸…æ™¨æ·¡è“
  bright:    '#F0E2A3', // æ­£åˆæ·¡é»„
  heavy:     '#6C7A89', // æš´é›¨å‰ç°è“
  confused:  '#C4C6C8', // é˜´äº‘æ·¡ç°
  fear:      '#3A1F1F', // å…‹åˆ¶æš—é»‘çº¢
  forgotten: '#FFFFFF' // è®°ä¸æ¸… / ç™½
};

/*************************
 * 3. è¯»å– / åˆå§‹åŒ–æ¢¦çš„æ•°æ®
 *************************/
var savedDreams = localStorage.getItem('dreams');

var dreams = savedDreams
  ? JSON.parse(savedDreams)
  : [
      {
        city: 'åŒ—äº¬',
        location: [39.9042, 116.4074],
        date: '2025-11-12',
        text: 'æˆ‘åœ¨æ¢¦é‡Œä¸€ç›´èµ°åœ¨ä¸€æ¡å›å®¶çš„è·¯ä¸Šã€‚',
        emotion: 'heavy',
        opacity: 0.5
      },
      {
        city: 'ä¸Šæµ·',
        location: [31.2304, 121.4737],
        date: '2026-01-18',
        text: 'æˆ‘åªè®°å¾—è‡ªå·±åšäº†ä¸€ä¸ªæ¢¦ï¼Œä½†é†’æ¥åä»€ä¹ˆéƒ½æƒ³ä¸èµ·æ¥ã€‚',
        emotion: 'forgotten',
        opacity: 0.3
      }
    ];
dreams.sort((a, b) => {
  return (a.createdAt || 0) - (b.createdAt || 0);
});


// åªå­˜ä¸€æ¬¡
//localStorage.setItem('dreams', JSON.stringify(dreams));

/*************************
 * 4. æŠŠâ€œæ¢¦â€ç”»åˆ°ä¸–ç•Œä¸Š
 *************************/
dreams.forEach(function(dream) {

// å¦‚æœè¿™ä¸ªæ¢¦æ²¡æœ‰ä½ç½®ï¼Œå°±è·³è¿‡ï¼ˆå…ˆä¸ç”»ï¼‰
if (!dream.location) return;

  // æ ¹æ®æ—¥æœŸè®¡ç®—æ¢¦çš„â€œå¹´é¾„â€
  var today = new Date();
  var dreamDate = new Date(dream.date);
  var daysPassed = Math.floor(
    (today - dreamDate) / (1000 * 60 * 60 * 24)
  );
  var isNewDream = daysPassed <= 30;

  // æ ¹æ®æ—¶é—´è®©æ¢¦å˜å¾—å®‰é™
 var timeOpacity = 0.6;

if (daysPassed > 7) timeOpacity = 0.35;
if (daysPassed > 30) timeOpacity = 0.25;
if (daysPassed > 90) timeOpacity = 0.15;
if (daysPassed > 180) timeOpacity = 0.1;
if (daysPassed > 270) timeOpacity = 0.05;
if (daysPassed > 365) timeOpacity = 0.03;
if (daysPassed > 730) timeOpacity = 0;


  // è®©åŒåŸçš„æ¢¦ç¨å¾®åˆ†æ•£
  var offsetLat = (Math.random() - 0.5) * 0.3;
  var offsetLng = (Math.random() - 0.5) * 0.3;

  var dreamLocation = [
    dream.location[0] + offsetLat,
    dream.location[1] + offsetLng
  ];

  var color = emotionColors[dream.emotion] || '#AAAAAA';
  
if (timeOpacity <= 0) return;

var marker = L.circleMarker(dreamLocation, {
  radius: isNewDream ? 10 : 6,   // æ–°æ¢¦æ›´å¤§
  stroke: false,
  fillColor: color,
  fillOpacity: timeOpacity
}).addTo(map);
if (isNewDream) {
  setTimeout(function () {
    marker.setRadius(6);
  }, 5000); // 5 ç§’åæ¢å¤æ­£å¸¸å¤§å°
}


// å¦‚æœæ˜¯æ–°æ¢¦ï¼Œè®©å®ƒå‘¼å¸
//if (isNewDream) {
  //marker.getElement().classList.add('dream-breath');
// }

// å¼¹çª—
marker.bindPopup(`
  <strong>ğŸŒ™ ${dream.date} çš„æ¢¦</strong><br/>
  æ—¥æœŸï¼š${dream.date}<br/>
  åœ°ç‚¹ï¼š${dream.city}<br/><br/>
  ${dream.text}
`);

});

</script>
</body>
</html>
